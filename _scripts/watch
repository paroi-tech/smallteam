#!/bin/bash
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

cd $DIR/..

# Clean old backend files
echo ">> Compile the backend"
rm -rf www-server/{backend,isomorphic}/* || exit 1
node_modules/.bin/tsc --project backend/ || exit 1

# Compile SCSS once
echo ">> Compile the SCSS once"
node_modules/.bin/node-sass --recursive --source-map-embed --output-style expanded frontend/ -o www-server/www || exit 1

# Thanks to http://unix.stackexchange.com/a/55922
trap 'killall' INT

killall() {
  trap '' INT TERM # ignore INT and TERM while shutting down
  echo "";
  echo "End of background processes..."
  kill -TERM 0
  wait
  echo "... done."
}

echo ">> Start the watchers"

# Watch the frontend
node_modules/.bin/node-sass --watch --recursive --source-map-embed --output-style expanded frontend/ -o www-server/www/ &
node_modules/.bin/webpack --watch --config frontend/webpack.config.js &

# Watch the backend
node_modules/.bin/tsc --watch --project backend/ &

# Start the Web server (in developer mode with "nodemon")
sleep 6
echo ">> Start the Web server"
node_modules/.bin/nodemon --watch www-server -e "js" www-server/backend/ # wait forever

#cat # wait forever